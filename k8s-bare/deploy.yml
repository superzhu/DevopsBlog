---
# Run this play as root user
- hosts: localhost
  gather_facts: no
  roles:
    - role: kubectl
      tags: kubectl     
    - role: tls
      tags: tls

# second play
- name: Distribute TLS related files
  hosts: others
  gather_facts: yes
  tasks:
    - name: create a directory if it doesn't exist
      file:
        name: /etc/kubernetes/pki/etcd
        state: directory
      tags: disTLS

    - name: Distribute /etc/kubernetes kubeconfig files
      copy:
        src: "{{ item }}"
        dest: /etc/kubernetes
        mode: preserve
      with_fileglob:
        - /etc/kubernetes/*.kubeconfig
      tags: disTLS

    - name: Distribute /etc/kubernetes/pki TLS key and certificate files
      copy:
        src: "{{ item }}"
        dest: /etc/kubernetes/pki
        mode: preserve
      with_fileglob:
        - /etc/kubernetes/pki/*.crt
        - /etc/kubernetes/pki/*.csr
        - /etc/kubernetes/pki/*.key
      tags: disTLS

    - name: Distribute /etc/kubernetes/pki/etcd TLS key and certificate files
      copy:
        src: "{{ item }}"
        dest: /etc/kubernetes/pki/etcd
        mode: preserve
      with_fileglob:
        - /etc/kubernetes/pki/etcd/*.crt
        - /etc/kubernetes/pki/etcd/*.csr
        - /etc/kubernetes/pki/etcd/*.key
      tags: disTLS

# third play
- name: install docker and etcd3
  hosts: Allnode
  gather_facts: yes
  roles:
    - role: docker
      tags: docker
